<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ducky & Pips Kingdom</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ducky & Pips">
    <meta name="theme-color" content="#fdf2f8">

    <!-- App Icon -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/rubber-duck.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/192/rubber-duck.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'bounce-slight': 'bounce 2s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: 0 },
                            '100%': { transform: 'scale(1)', opacity: 1 },
                        }
                    },
                    colors: {
                        ducky: '#fef08a', 
                        duckyDark: '#854d0e',
                        pips: '#bfdbfe',
                        pipsDark: '#1e40af',
                        themeYellow: '#fef08a',
                        themeYellowDark: '#854d0e',
                        themeBlue: '#bfdbfe',
                        themeBlueDark: '#1e40af',
                        themePink: '#fbcfe8',
                        themePinkDark: '#9d174d',
                        themeGreen: '#bbf7d0',
                        themeGreenDark: '#166534',
                        themePurple: '#e9d5ff',
                        themePurpleDark: '#6b21a8',
                        themeOrange: '#fed7aa',
                        themeOrangeDark: '#9a3412',
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 rgba(0,0,0,0.05)',
                        'glow': '0 0 20px rgba(255, 255, 255, 0.8)',
                    }
                }
            }
        }
    </script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.378.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .perspective-1000 { perspective: 1000px; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        body { -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; background-color: #fdf2f8; background-image: radial-gradient(#fbcfe8 2px, transparent 2px); background-size: 24px 24px; }
        input, textarea, select { -webkit-user-select: auto; user-select: auto; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Heart, Trash2, Plus, Calendar, Repeat, CheckCircle, User, Sparkles, 
            Utensils, Camera, Gift, ArrowLeft, ArrowRight, RefreshCw, LogOut, 
            Star, AlertTriangle, MessageCircle, X, WifiOff, Coins, PiggyBank,
            TrendingUp, DollarSign, HandCoins, Target, CheckSquare, PlusCircle,
            CalendarDays, Clock, Users, ChevronLeft, ChevronRight, AlertCircle,
            Crown, Flag, Settings, BookOpen, Sun, Moon, Coffee, ShoppingCart, ShoppingBag,
            Edit3, MessageSquareHeart
        } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged 
        } from 'firebase/auth';
        import { 
            getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, 
            deleteDoc, query, orderBy, serverTimestamp, getDoc, setDoc 
        } from 'firebase/firestore';

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Uncaught error:", error, errorInfo); }
            render() { if (this.state.hasError) return <div className="p-6 text-center h-screen flex flex-col items-center justify-center"><h2 className="text-xl font-bold text-red-500 mb-2">Oh no! A glitch! üêõ</h2><button onClick={() => window.location.reload()} className="bg-black text-white px-6 py-3 rounded-full font-bold shadow-cute">Reload Kingdom</button></div>; return this.props.children; }
        }

        // --- Config & Mock ---
        const defaultAppId = 'ducky-pips-v1';
        const appId = typeof __app_id !== 'undefined' ? __app_id : defaultAppId;
        
        // Mock Service for Offline/LocalStorage fallback
        const MockService = {
            storageKey: (col) => `ducky_pips_${col}`,
            initAuth: (cb) => { setTimeout(() => cb({ uid: 'offline-user', isAnonymous: true }), 500); return () => {}; },
            subscribe: (col, cb) => { const k=MockService.storageKey(col); const l=()=>{try{const r=localStorage.getItem(k);cb({docs:(r?JSON.parse(r):[]).map(d=>({id:d.id,data:()=>d}))});}catch(e){cb({docs:[]});}}; l(); const h=()=>l(); window.addEventListener('ls-up',h); return ()=>window.removeEventListener('ls-up',h); },
            subscribeDoc: (col, id, cb) => { const k=MockService.storageKey(col); const l=()=>{const r=localStorage.getItem(k);const i=(r?JSON.parse(r):[]).find(x=>x.id===id);cb({exists:()=>!!i,data:()=>i});}; l(); const h=()=>l(); window.addEventListener('ls-up',h); return ()=>window.removeEventListener('ls-up',h); },
            set: async (col, id, d) => { const k=MockService.storageKey(col); const r=localStorage.getItem(k); let l=r?JSON.parse(r):[]; const idx=l.findIndex(x=>x.id===id); const p={...d,id}; if(idx!==-1)l[idx]={...l[idx],...p};else l.push(p); localStorage.setItem(k,JSON.stringify(l)); window.dispatchEvent(new Event('ls-up')); },
            add: async (col, d) => { const k=MockService.storageKey(col); const r=localStorage.getItem(k); const l=r?JSON.parse(r):[]; const id='loc_'+Date.now(); l.push({...d,id,createdAt:{seconds:Date.now()/1000}}); localStorage.setItem(k,JSON.stringify(l)); window.dispatchEvent(new Event('ls-up')); return {id}; },
            update: async (col, id, d) => { const k=MockService.storageKey(col); const r=localStorage.getItem(k); let l=r?JSON.parse(r):[]; const idx=l.findIndex(x=>x.id===id); if(idx!==-1){ l[idx]={...l[idx],...d}; localStorage.setItem(k,JSON.stringify(l)); window.dispatchEvent(new Event('ls-up')); } },
            delete: async (col, id) => { const k=MockService.storageKey(col); const r=localStorage.getItem(k); let l=r?JSON.parse(r):[]; localStorage.setItem(k,JSON.stringify(l.filter(x=>x.id!==id))); window.dispatchEvent(new Event('ls-up')); },
            get: async (col, id) => { const key = MockService.storageKey(col); const r = localStorage.getItem(key); const l = r ? JSON.parse(r) : []; const i = l.find(x => x.id === id); return { exists: () => !!i, data: () => i }; }
        };

        // Firebase Initialization with Environment fallback
        let app, auth, db;
        let isOffline = false;
        
        try {
            const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            if (configStr) {
                const firebaseConfig = JSON.parse(configStr);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isOffline = false;
            } else {
                throw new Error("No config");
            }
        } catch(e) {
            console.warn("Using Offline Mode (LocalStorage)", e);
            isOffline = true;
        }

        const CHORES_PER_COUPON = 5; const CHORES_PER_DATENIGHT = 20;
        const FREQUENCIES = ['Once', 'Daily', 'Weekly', 'Monthly', 'Yearly'];
        const GOAL_TIMEFRAMES = ["1 Month", "1 Year", "5 Years", "10 Years", "20 Years"];
        const COUPON_TYPES = ["15 min Back Massage", "Homemade Dinner Choice", "Dish Duty Pass", "Movie Selection", "Breakfast in Bed", "Foot Massage", "Veto Power", "Ice Cream Run", "Bubble Bath Setup", "30 min Gaming Time"];
        const DATE_VIBES = ["Cozy", "Fancy", "Adventurous", "Chill", "Romantic", "Spooky", "Nostalgic"];
        const DATE_ACTIVITIES = ["Mini Golf", "Board Games", "Stargazing", "Arcade", "Cooking Class", "Museum", "Hiking", "Movie Marathon"];
        const DATE_FOODS = ["Sushi", "Pizza", "Tacos", "Thai", "Burgers", "Fondue", "Pasta", "Picnic"];
        const DATE_PLACES = ["Living Room Fort", "Downtown", "New Restaurant", "The Park", "Beach/Lake", "Rooftop Bar", "Local Cafe"];
        const MEETING_QUESTIONS = ["What was the highlight of your week?", "What is one thing I did that made you feel loved?", "Is there anything stressing you out that I can help with?", "What is one goal you want us to focus on this week?", "How can we have more fun together?", "What's one thing I can do more of next week?", "What was your favorite meal we had recently?", "Are you feeling balanced with our chores?"];
        const THEME_COLORS = [
            { name: 'Yellow', bg: 'bg-themeYellow', text: 'text-themeYellowDark', border: 'border-themeYellow' },
            { name: 'Blue', bg: 'bg-themeBlue', text: 'text-themeBlueDark', border: 'border-themeBlue' },
            { name: 'Pink', bg: 'bg-themePink', text: 'text-themePinkDark', border: 'border-themePink' },
            { name: 'Green', bg: 'bg-themeGreen', text: 'text-themeGreenDark', border: 'border-themeGreen' },
            { name: 'Purple', bg: 'bg-themePurple', text: 'text-themePurpleDark', border: 'border-themePurple' },
            { name: 'Orange', bg: 'bg-themeOrange', text: 'text-themeOrangeDark', border: 'border-themeOrange' },
        ];

        // --- Helper Components ---
        const ProgressBar = ({ current, max, color = "bg-pink-500", label }) => (
            <div className="w-full mb-4">
                {label && <div className="flex justify-between text-xs font-bold text-gray-400 mb-1 uppercase tracking-wider ml-1"><span>{label}</span><span>{current} / {max}</span></div>}
                <div className="h-5 w-full bg-white rounded-full overflow-hidden border-2 border-gray-100 shadow-inner">
                    <div className={`h-full ${color} transition-all duration-1000 ease-out flex items-center justify-end pr-2 rounded-full`} style={{ width: `${Math.min((current/max)*100, 100)}%` }}>{current>=max && <Sparkles size={12} className="text-white animate-spin-slow" />}</div>
                </div>
            </div>
        );

        function NavButton({ active, onClick, icon, label, count, prominent }) {
            if (prominent) {
                return (
                    <button onClick={onClick} className="relative -top-10 z-50 flex flex-col items-center justify-center group shrink-0 mx-1">
                        <div className={`w-20 h-20 rounded-full shadow-glow flex items-center justify-center border-[6px] border-gray-50 transition-transform duration-300 group-hover:scale-105 ${active ? 'bg-gradient-to-br from-pink-400 to-purple-500 text-white' : 'bg-white text-gray-300'}`}>
                            {React.cloneElement(icon, { size: 36, strokeWidth: 3 })}
                        </div>
                    </button>
                )
            }
            return (
                <button onClick={onClick} className={`flex flex-col items-center justify-center gap-0.5 transition-all relative w-full aspect-square rounded-2xl ${active ? 'bg-white shadow-cute text-pink-500 -translate-y-1' : 'text-gray-400 hover:text-gray-600 hover:bg-white/50'}`}>
                    {React.cloneElement(icon, { size: 24, strokeWidth: 2.5 })}
                    <span className="text-[9px] font-bold leading-tight">{label}</span>
                    {count > 0 && <span className="absolute top-1 right-1 bg-red-500 text-white text-[8px] w-4 h-4 rounded-full flex items-center justify-center font-bold animate-bounce shadow-sm border border-white">{count}</span>}
                </button>
            );
        }

        function ModalWrapper({ children, onClose, title, icon }) {
            return (
                <div className="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl animate-in zoom-in-95 duration-200 border-4 border-gray-100 relative max-h-[85vh] overflow-y-auto no-scrollbar">
                        <button onClick={onClose} className="absolute top-6 right-6 text-gray-300 hover:text-gray-500 bg-gray-50 p-2 rounded-full"><X size={20}/></button>
                        <h2 className="text-2xl font-black text-gray-800 mb-6 flex items-center gap-3">{icon} {title}</h2>
                        {children}
                    </div>
                </div>
            );
        }

        // --- Item Components ---
        const ChoreItem = ({ chore, onToggle, onDelete, isPretty, showAssignee }) => {
            const isOverdue = chore.dueDate && new Date(chore.dueDate) < new Date() && !isPretty;
            return (
                <div className={`group relative bg-white rounded-3xl p-4 shadow-cute border-2 transition-all hover:shadow-md flex items-center gap-4 animate-pop ${isPretty ? 'border-pink-200 bg-gradient-to-r from-white to-pink-50' : 'border-gray-100'} ${isOverdue ? 'border-red-200 bg-red-50' : ''}`}>
                    <button onClick={() => onToggle(chore)} className={`w-10 h-10 rounded-full border-4 flex items-center justify-center transition-colors shadow-sm shrink-0 ${isPretty ? 'border-pink-200 text-pink-500 hover:bg-pink-100' : 'border-gray-200 text-transparent hover:border-green-400 hover:text-green-400 bg-gray-50'}`}><CheckCircle size={22} strokeWidth={3} className={isPretty?"opacity-100":"opacity-0 hover:opacity-100"}/></button>
                    <div className="flex-1 overflow-hidden">
                        <h3 className={`font-black text-gray-700 text-lg leading-tight truncate ${isPretty ? 'text-pink-600' : ''}`}>{chore.title}</h3>
                        <div className="flex flex-wrap gap-2 text-[10px] font-bold text-gray-400 mt-1.5">
                            {showAssignee && <span className={`flex items-center gap-1 px-2 py-1 rounded-lg bg-gray-100 text-gray-600`}>{chore.assignedTo}</span>}
                            {!isPretty && chore.frequency && <span className="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-lg"><RefreshCw size={10} /> {chore.frequency}</span>}
                            {!isPretty && chore.dueDate && <span className={`flex items-center gap-1 px-2 py-1 rounded-lg ${isOverdue ? 'bg-red-100 text-red-600' : 'bg-gray-100'}`}><Calendar size={10} /> {new Date(chore.dueDate).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</span>}
                            {isPretty && <span className="flex items-center gap-1 bg-pink-100 text-pink-600 px-2 py-1 rounded-lg border border-pink-200">Favor ‚ú®</span>}
                        </div>
                    </div>
                    {onDelete && <button onClick={() => onDelete(chore.id)} className="opacity-0 group-hover:opacity-100 p-2 text-gray-300 hover:text-red-400 transition-opacity bg-white rounded-full shadow-sm border border-gray-100 shrink-0"><Trash2 size={18}/></button>}
                </div>
            );
        };

        const GoalItem = ({ goal, onUpdate, onDelete }) => {
            const [expand, setExpand] = useState(false); const [add, setAdd] = useState(''); const [task, setTask] = useState('');
            const prog = goal.financialTarget ? Math.min((goal.savedAmount/goal.financialTarget)*100,100) : 0;
            return (
                <div className="bg-white rounded-3xl p-5 shadow-cute border-2 border-gray-100 overflow-hidden animate-pop">
                    <div className="flex justify-between items-start cursor-pointer" onClick={()=>setExpand(!expand)}><div className="flex-1"><h3 className="font-black text-gray-700 text-lg">{goal.title}</h3><div className="mt-2 h-2.5 w-full bg-gray-100 rounded-full overflow-hidden border border-gray-200"><div style={{width:`${prog}%`}} className="h-full bg-gradient-to-r from-green-400 to-emerald-500"></div></div></div><button onClick={(e)=>{e.stopPropagation(); onDelete(goal.id);}} className="text-gray-300 ml-4 hover:text-red-400"><Trash2 size={16}/></button></div>
                    {expand && <div className="mt-4 pt-4 border-t-2 border-gray-50"><form onSubmit={(e)=>{e.preventDefault(); if(add) onUpdate(goal.id, {savedAmount:(goal.savedAmount||0)+parseFloat(add)}); setAdd('');}} className="flex gap-2 mb-4"><input type="number" placeholder="$" className="w-20 bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold" value={add} onChange={e=>setAdd(e.target.value)} /><button className="bg-green-500 text-white px-4 py-2 rounded-xl text-xs font-black shadow-cute hover:translate-y-0.5 transition-transform">ADD</button></form><div className="space-y-2 mb-3">{(goal.tasks||[]).map(t=><div key={t.id} onClick={()=>{const n=goal.tasks.map(x=>x.id===t.id?{...x,completed:!x.completed}:x); onUpdate(goal.id,{tasks:n});}} className="flex gap-3 items-center group cursor-pointer"><div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-colors ${t.completed?'bg-indigo-500 border-indigo-500':'border-gray-300 bg-white'}`}>{t.completed&&<CheckCircle size={14} className="text-white"/>}</div><span className={`text-sm font-medium ${t.completed?'text-gray-300 line-through':'text-gray-600'}`}>{t.text}</span></div>)}</div><form onSubmit={(e)=>{e.preventDefault(); if(task) { onUpdate(goal.id, {tasks:[...(goal.tasks||[]),{id:Date.now(),text:task,completed:false}]}); setTask(''); } }} className="flex gap-2"><input type="text" placeholder="Add step..." className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold" value={task} onChange={e=>setTask(e.target.value)}/><button className="bg-gray-100 text-gray-400 p-2 rounded-xl hover:bg-indigo-100 hover:text-indigo-500 transition-colors"><PlusCircle size={20}/></button></form></div>}
                </div>
            );
        };

        // --- Modals ---
        const ProfileSettingsModal = ({ onClose, profile, settings, onSave }) => {
            const [name, setName] = useState(settings.name); const [icon, setIcon] = useState(settings.icon); const [theme, setTheme] = useState(settings.theme || 'Yellow');
            const icons = ['üê•','üê¶','üê∏','üê∑','ü¶Ñ','üêº','ü¶ä','ü¶Å','üêß','üêù'];
            return (
                <ModalWrapper onClose={onClose} title="My Profile" icon={<User className="text-blue-400" size={28}/>}>
                    <div className="space-y-6">
                        <div><label className="block text-xs font-black text-gray-400 mb-2 uppercase ml-1">Name</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 font-bold text-gray-700" value={name} onChange={e=>setName(e.target.value)}/></div>
                        <div><label className="block text-xs font-black text-gray-400 mb-2 uppercase ml-1">Icon</label><div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">{icons.map(ic=><button key={ic} onClick={()=>setIcon(ic)} className={`text-2xl p-3 rounded-2xl border-2 transition-all ${icon===ic?'border-black bg-gray-100':'border-transparent hover:bg-gray-50'}`}>{ic}</button>)}</div></div>
                        <div><label className="block text-xs font-black text-gray-400 mb-2 uppercase ml-1">Theme</label><div className="grid grid-cols-3 gap-2">{THEME_COLORS.map(t=><button key={t.name} onClick={()=>setTheme(t.name)} className={`py-3 rounded-2xl text-xs font-bold border-2 transition-all ${theme===t.name? 'border-black opacity-100 scale-105':'border-transparent opacity-60'} ${t.bg} ${t.text}`}>{t.name}</button>)}</div></div>
                        <button onClick={()=>{onSave({name,icon,theme}); onClose();}} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-cute mt-2">Save Profile</button>
                    </div>
                </ModalWrapper>
            );
        };

        const AddChoreModal = ({ onClose, onAdd }) => {
            const [isPretty, setIsPretty] = useState(false); const [title, setTitle] = useState(''); const [freq, setFreq] = useState('Once'); const [date, setDate] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (!title) return; onAdd({ title, isPrettyPlease: isPretty, frequency: isPretty ? null : freq, dueDate: isPretty ? null : date }); };
            return (
                <ModalWrapper onClose={onClose} title="New Chore" icon={<CheckSquare className="text-blue-400" size={28}/>}><form onSubmit={handleSubmit} className="space-y-5"><div onClick={() => setIsPretty(!isPretty)} className={`cursor-pointer p-5 rounded-2xl border-2 transition-all flex items-center gap-4 ${isPretty ? 'border-pink-300 bg-pink-50' : 'border-gray-100 hover:border-pink-200'}`}><div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center ${isPretty ? 'bg-pink-400 border-pink-400' : 'border-gray-300 bg-white'}`}>{isPretty && <CheckCircle size={18} className="text-white" />}</div><div><span className={`font-black text-lg block ${isPretty ? 'text-pink-600' : 'text-gray-600'}`}>Pretty Please?</span><span className="text-xs font-bold text-gray-400">Special favor!</span></div></div><div><label className="block text-xs font-black text-gray-400 mb-2 uppercase tracking-wide ml-1">Chore Name</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 font-bold text-gray-700" placeholder="e.g. Wash dishes" value={title} onChange={e => setTitle(e.target.value)} autoFocus /></div>{!isPretty && (<div className="flex gap-4"><div className="flex-1"><label className="block text-xs font-black text-gray-400 mb-2 uppercase tracking-wide ml-1">Frequency</label><select className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 text-sm font-bold text-gray-700" value={freq} onChange={e => setFreq(e.target.value)}>{FREQUENCIES.map(f => <option key={f} value={f}>{f}</option>)}</select></div><div className="flex-1"><label className="block text-xs font-black text-gray-400 mb-2 uppercase tracking-wide ml-1">Due Date</label><input type="date" className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 text-sm font-bold text-gray-700" value={date} onChange={e => setDate(e.target.value)} /></div></div>)}<button type="submit" className={`w-full py-4 rounded-2xl font-black text-white text-lg shadow-cute hover:translate-y-1 transition-all mt-4 ${isPretty ? 'bg-pink-500' : 'bg-black'}`}>Add It!</button></form></ModalWrapper>
            );
        };
        const AddBillModal = ({ onClose, onAdd }) => { const [title, setTitle] = useState(''); const [amount, setAmount] = useState(''); const [date, setDate] = useState(''); const handleSubmit = (e) => { e.preventDefault(); if (!title || !amount) return; onAdd({ title, amount: parseFloat(amount), date: date || new Date().toISOString() }); }; return (<ModalWrapper onClose={onClose} title="New Bill" icon={<DollarSign className="text-green-500" size={28}/>}><form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Bill Name</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 font-bold" value={title} onChange={e => setTitle(e.target.value)} autoFocus /></div><div className="flex gap-4"><div className="flex-1"><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Amount ($)</label><input type="number" className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 font-bold" value={amount} onChange={e => setAmount(e.target.value)} /></div><div className="flex-1"><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Due Date</label><input type="date" className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 font-bold" value={date} onChange={e => setDate(e.target.value)} /></div></div><button type="submit" className="w-full py-3 font-black text-white bg-green-500 rounded-2xl shadow-cute mt-2">Add Bill</button></form></ModalWrapper>); };
        const AddGoalModal = ({ onClose, onAdd, user }) => { const [title, setTitle] = useState(''); const [timeframe, setTimeframe] = useState('1 Year'); const [type, setType] = useState('personal'); const [hasFinance, setHasFinance] = useState(false); const [target, setTarget] = useState(''); const handleSubmit = (e) => { e.preventDefault(); if (!title) return; onAdd({ title, timeframe, type, owner: user, financialTarget: hasFinance ? parseFloat(target) : 0 }); }; return (<ModalWrapper onClose={onClose} title="New Goal" icon={<Target className="text-indigo-500" size={28}/>}><form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Goal Name</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 font-bold" value={title} onChange={e => setTitle(e.target.value)} autoFocus /></div><div className="flex gap-4"><div className="flex-1"><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Timeframe</label><select className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 text-sm font-bold" value={timeframe} onChange={e => setTimeframe(e.target.value)}>{GOAL_TIMEFRAMES.map(t => <option key={t} value={t}>{t}</option>)}</select></div><div className="flex-1"><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Type</label><div className="flex bg-gray-100 rounded-2xl p-1"><button type="button" onClick={() => setType('personal')} className={`flex-1 py-2 rounded-xl text-xs font-bold ${type === 'personal' ? 'bg-white shadow text-indigo-600' : 'text-gray-400'}`}>Me</button><button type="button" onClick={() => setType('shared')} className={`flex-1 py-2 rounded-xl text-xs font-bold ${type === 'shared' ? 'bg-white shadow text-pink-600' : 'text-gray-400'}`}>Us</button></div></div></div><div className="bg-gray-50 p-3 rounded-2xl border-2 border-gray-100"><div className="flex items-center justify-between mb-2" onClick={() => setHasFinance(!hasFinance)}><span className="text-xs font-bold text-gray-500">Financial Target?</span><div className={`w-10 h-6 rounded-full p-1 transition-colors ${hasFinance ? 'bg-green-400' : 'bg-gray-300'}`}><div className={`w-4 h-4 bg-white rounded-full shadow transition-transform ${hasFinance ? 'translate-x-4' : ''}`}></div></div></div>{hasFinance && (<input type="number" placeholder="Target Amount ($)" className="w-full bg-white border-2 border-gray-200 rounded-lg p-2 text-sm" value={target} onChange={e => setTarget(e.target.value)} />)}</div><button type="submit" className="w-full py-3 font-black text-white bg-indigo-500 rounded-2xl shadow-cute mt-2">Set Goal</button></form></ModalWrapper>); };
        const AddEventModal = ({ onClose, onAdd, user }) => { const [title, setTitle] = useState(''); const [date, setDate] = useState(new Date().toISOString().split('T')[0]); const [time, setTime] = useState('12:00'); const [type, setType] = useState('personal'); const [duration, setDuration] = useState('1'); const [durationUnit, setDurationUnit] = useState('Hours'); const handleSubmit = (e) => { e.preventDefault(); if (!title) return; onAdd({ title, date, time, type, duration, durationUnit, owner: user }); }; return (<ModalWrapper onClose={onClose} title="New Event" icon={<CalendarDays className="text-pink-500" size={28}/>}><form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Event Title</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 font-bold" value={title} onChange={e => setTitle(e.target.value)} autoFocus /></div><div className="flex gap-4"><div className="flex-1"><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Date</label><input type="date" className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 text-sm font-bold" value={date} onChange={e => setDate(e.target.value)} /></div><div className="flex-1"><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Time</label><input type="time" className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 text-sm font-bold" value={time} onChange={e => setTime(e.target.value)} /></div></div><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Duration</label><div className="flex gap-2"><input type="number" className="w-20 bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 text-sm font-bold" value={duration} onChange={e => setDuration(e.target.value)} /><select className="flex-1 bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 text-sm font-bold" value={durationUnit} onChange={e => setDurationUnit(e.target.value)}><option>Hours</option><option>Days</option></select></div></div><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Type</label><div className="flex bg-gray-100 rounded-2xl p-1"><button type="button" onClick={() => setType('personal')} className={`flex-1 py-2 rounded-xl text-xs font-bold ${type === 'personal' ? 'bg-white shadow text-blue-600' : 'text-gray-400'}`}>Just Me</button><button type="button" onClick={() => setType('shared')} className={`flex-1 py-2 rounded-xl text-xs font-bold ${type === 'shared' ? 'bg-white shadow text-pink-600' : 'text-gray-400'}`}>Group Event</button></div></div><button type="submit" className="w-full py-3 font-black text-white bg-pink-500 rounded-2xl shadow-cute mt-2">Add Event</button></form></ModalWrapper>); };
        const AddShoppingModal = ({ onClose, onAdd }) => { const [item, setItem] = useState(''); const handleSubmit = (e) => { e.preventDefault(); if (!item) return; onAdd({ text: item, completed: false }); }; return (<ModalWrapper onClose={onClose} title="Add Item" icon={<ShoppingBag className="text-orange-400" size={28}/>}><form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Item Name</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 font-bold" value={item} onChange={e => setItem(e.target.value)} autoFocus /></div><button type="submit" className="w-full py-3 font-black text-white bg-orange-400 rounded-2xl shadow-cute mt-2">Add to List</button></form></ModalWrapper>); };
        const IOUModal = ({ onClose, onRequest }) => { const [amount, setAmount] = useState(''); const [reason, setReason] = useState(''); const handleSubmit = (e) => { e.preventDefault(); if (!amount) return; onRequest(amount, reason); }; return (<ModalWrapper onClose={onClose} title="Pretty Please?" icon={<HandCoins className="text-pink-500" size={28}/>}><form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Amount ($)</label><input type="number" className="w-full bg-pink-50 border-2 border-pink-200 rounded-2xl p-3 font-black text-pink-600 text-lg" value={amount} onChange={e => setAmount(e.target.value)} autoFocus /></div><div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">For What?</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-3 font-medium" placeholder="e.g. Ice Cream üç¶" value={reason} onChange={e => setReason(e.target.value)} /></div><button type="submit" className="w-full py-3 font-black text-white bg-pink-500 rounded-2xl shadow-cute mt-2">Ask!</button></form></ModalWrapper>); };
        const MeetingModal = ({ onClose, chores, events, user, onAdd }) => { 
            const today = new Date(); 
            const tomorrow = new Date(today); 
            tomorrow.setDate(today.getDate() + 1); 
            
            const missed = chores.filter(c => c.status !== 'completed' && c.dueDate && new Date(c.dueDate) < today && new Date(c.dueDate).getDate() !== today.getDate()); 
            const todayTasks = chores.filter(c => c.status !== 'completed' && (!c.dueDate || new Date(c.dueDate).toDateString() === today.toDateString()));
            const dueTmr = chores.filter(c => c.dueDate && new Date(c.dueDate).toDateString() === tomorrow.toDateString()); 
            
            const tmrEvents = events.filter(e => e.date && new Date(e.date).toDateString() === tomorrow.toDateString());
            
            const [step, setStep] = useState(0); 
            const [newChore, setNewChore] = useState(''); 
            const [assign, setAssign] = useState(user); 
            
            const handleAdd = (e) => { e.preventDefault(); if(!newChore) return; onAdd({ title: newChore, assignedTo: assign, dueDate: today.toISOString().split('T')[0] }); setNewChore(''); }; 
            
            const content = [
                <div key="intro" className="text-center animate-in zoom-in">
                    <h3 className="text-2xl font-black text-gray-800 mb-2">Household Meeting</h3>
                    <p className="text-gray-500 mb-6 font-medium">A daily check-in to align, support, and grow.</p>
                    <div className="bg-pink-50 p-6 rounded-full inline-block mb-6 shadow-cute"><BookOpen size={64} className="text-pink-400"/></div>
                    <button onClick={()=>setStep(1)} className="w-full bg-black text-white py-3 rounded-2xl font-black shadow-cute">Start Meeting</button>
                </div>, 
                <div key="checkin" className="animate-in slide-in-from-right">
                    <h3 className="text-xl font-black text-gray-800 mb-4 flex items-center gap-2"><CheckCircle className="text-blue-400"/> Check-In</h3>
                    
                    <h4 className="text-xs font-bold text-gray-400 uppercase mb-2">Missed / Overdue</h4>
                    {missed.length === 0 ? <div className="bg-green-50 p-3 rounded-xl text-green-600 font-bold text-sm border-2 border-green-100 mb-4">Nothing missed! üåü</div> : <div className="space-y-2 max-h-40 overflow-y-auto mb-4 custom-scrollbar">{missed.map(c => <div key={c.id} className="bg-red-50 p-2 rounded-lg border border-red-100 flex justify-between items-center"><span className="text-sm font-bold text-red-800">{c.title}</span><span className="text-[10px] font-black uppercase bg-white px-2 py-1 rounded-lg text-red-400">{c.assignedTo}</span></div>)}</div>}
                    
                    <h4 className="text-xs font-bold text-gray-400 uppercase mb-2">Remaining Today</h4>
                    {todayTasks.length === 0 ? <div className="bg-gray-50 p-3 rounded-xl text-gray-400 text-sm font-bold border-2 border-gray-100 italic">All done for today!</div> : <div className="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">{todayTasks.map(c => <div key={c.id} className="bg-white p-2 rounded-lg border border-gray-100 flex justify-between items-center"><span className="text-sm font-bold text-gray-700">{c.title}</span><span className="text-[10px] font-black uppercase bg-gray-100 px-2 py-1 rounded-lg text-gray-500">{c.assignedTo}</span></div>)}</div>}

                    <div className="flex gap-2 mt-4"><button onClick={()=>setStep(0)} className="flex-1 font-bold text-gray-400 hover:bg-gray-50 rounded-xl">Back</button><button onClick={()=>setStep(2)} className="flex-1 bg-black text-white py-3 rounded-xl font-bold shadow-cute">Next</button></div>
                </div>, 
                <div key="tmr" className="animate-in slide-in-from-right">
                    <h3 className="text-xl font-black text-gray-800 mb-4 flex items-center gap-2"><Sun className="text-yellow-400"/> Tomorrow's Plan</h3>
                    
                    {tmrEvents.length > 0 && (
                        <div className="mb-4">
                            <h4 className="text-xs font-bold text-pink-400 uppercase mb-2">Calendar</h4>
                            <div className="space-y-2">{tmrEvents.map(e => <div key={e.id} className="bg-pink-50 p-2 rounded-lg border border-pink-100 text-sm font-bold text-pink-700 flex gap-2"><Clock size={16}/> {e.time} - {e.title}</div>)}</div>
                        </div>
                    )}

                    <h4 className="text-xs font-bold text-gray-400 uppercase mb-2">Chores</h4>
                    {dueTmr.length === 0 ? <p className="text-center text-gray-400 py-2 mb-4 italic text-sm">Free day tomorrow!</p> : <div className="space-y-2 max-h-40 overflow-y-auto mb-4 custom-scrollbar">{dueTmr.map(c => <div key={c.id} className="bg-yellow-50 p-2 rounded-lg border border-yellow-100 flex justify-between items-center"><span className="text-sm font-bold text-yellow-800">{c.title}</span><span className="text-[10px] font-black uppercase bg-white px-2 py-1 rounded-lg text-yellow-600">{c.assignedTo}</span></div>)}</div>}
                    
                    <div className="border-t-2 border-gray-100 pt-4 mb-4">
                        <h4 className="text-[10px] font-black text-gray-400 uppercase mb-2 ml-1">Add Last Minute Chore</h4>
                        <form onSubmit={handleAdd} className="flex gap-2"><input value={newChore} onChange={e=>setNewChore(e.target.value)} className="flex-1 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm font-bold focus:outline-none focus:border-black" placeholder="Quick add..." /><select value={assign} onChange={e=>setAssign(e.target.value)} className="bg-gray-100 rounded-xl text-xs font-bold px-2"><option value="Ducky">Ducky</option><option value="Pips">Pips</option></select><button type="submit" className="bg-black text-white px-3 rounded-xl"><Plus size={20}/></button></form>
                    </div>
                    <div className="flex gap-2"><button onClick={()=>setStep(1)} className="flex-1 font-bold text-gray-400 hover:bg-gray-50 rounded-xl">Back</button><button onClick={()=>setStep(3)} className="flex-1 bg-black text-white py-3 rounded-xl font-bold shadow-cute">Next</button></div>
                </div>, 
                 <div key="vibes" className="animate-in slide-in-from-right text-center">
                    <h3 className="text-xl font-black text-gray-800 mb-2 flex items-center justify-center gap-2"><Sparkles className="text-yellow-400"/> Positive Vibes</h3>
                    <p className="text-sm text-gray-500 mb-6">Take a moment to appreciate something your partner did today.</p>
                    <div className="bg-yellow-50 p-8 rounded-[2rem] mb-6 border-2 border-yellow-100">
                        <div className="text-4xl mb-4">üèÜ</div>
                        <h4 className="font-black text-yellow-800 text-lg mb-2">Small Wins Matter!</h4>
                        <p className="text-yellow-700 text-sm">You both completed tasks this week. Keep building that Kingdom together!</p>
                    </div>
                    <div className="flex gap-2"><button onClick={()=>setStep(2)} className="flex-1 font-bold text-gray-400 hover:bg-gray-50 rounded-xl">Back</button><button onClick={()=>setStep(4)} className="flex-1 bg-black text-white py-3 rounded-xl font-bold shadow-cute">Reflect</button></div>
                </div>,
                <div key="reflect" className="animate-in slide-in-from-right text-center">
                    <h3 className="text-xl font-black text-gray-800 mb-2 flex items-center justify-center gap-2"><MessageSquareHeart className="text-pink-500"/> Reflection</h3>
                    <div className="bg-pink-50 p-6 rounded-[2rem] mb-6 relative border-2 border-pink-100">
                        <Coffee className="absolute top-4 right-4 text-pink-200" size={32}/>
                        <p className="text-lg font-bold text-pink-800 italic leading-snug">"{MEETING_QUESTIONS[Math.floor(Math.random()*MEETING_QUESTIONS.length)]}"</p>
                    </div>
                    <button onClick={onClose} className="w-full bg-black text-white py-3 rounded-2xl font-bold shadow-cute">End Meeting</button>
                </div>
            ]; 
            return <ModalWrapper onClose={onClose} title="" icon={null}><div className="-mt-8">{content[step]}</div></ModalWrapper>; 
        };
        const DateGeneratorModal = ({ date, onClose, onSave }) => { if (!date) return null; const [step, setStep] = useState(1); const [review, setReview] = useState(''); const [photo, setPhoto] = useState(null); const handlePhotoChange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => setPhoto(reader.result); reader.readAsDataURL(file); } }; if (step === 1) return (<ModalWrapper onClose={onClose} title="Tonight's Plan!" icon={<Sparkles className="text-yellow-400" size={28}/>}><div className="space-y-4 mb-6"><div className="bg-pink-50 p-4 rounded-3xl border-2 border-pink-100 text-center"><span className="block text-[10px] font-black text-pink-400 uppercase mb-1">Vibe</span><span className="text-2xl font-black text-pink-600">{date.vibe}</span></div><div className="flex gap-4"><div className="bg-blue-50 p-4 rounded-3xl border-2 border-blue-100 flex-1 text-center"><span className="block text-[10px] font-black text-blue-400 uppercase mb-1">Eat</span><span className="text-lg font-black text-blue-600 leading-tight block">{date.food}</span></div><div className="bg-green-50 p-4 rounded-3xl border-2 border-green-100 flex-1 text-center"><span className="block text-[10px] font-black text-green-400 uppercase mb-1">Go To</span><span className="text-lg font-black text-green-600 leading-tight block">{date.place}</span></div></div><div className="bg-yellow-50 p-4 rounded-3xl border-2 border-yellow-100 text-center"><span className="block text-[10px] font-black text-yellow-500 uppercase mb-1">Activity</span><span className="text-xl font-black text-yellow-700">{date.activity}</span></div></div><button onClick={() => setStep(2)} className="w-full bg-black text-white py-4 rounded-2xl font-black shadow-cute hover:scale-105 transition-transform">We Did It! (Log Memory)</button></ModalWrapper>); return (<ModalWrapper onClose={onClose} title="How was it?" icon={<Heart className="text-red-500" size={28}/>}><textarea className="w-full bg-gray-50 border-2 border-gray-200 rounded-2xl p-4 text-sm font-medium focus:outline-none focus:border-pink-300 mb-4 h-32 resize-none" placeholder="Write a cute note about the date..." value={review} onChange={e => setReview(e.target.value)} /><div className="mb-6"><label className="flex items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-2xl cursor-pointer hover:bg-gray-50 transition-colors bg-white">{photo ? <img src={photo} alt="Preview" className="h-full w-full object-cover rounded-2xl" /> : <div className="flex flex-col items-center text-gray-400"><Camera size={24} className="mb-2" /><span className="text-xs font-bold">Add a photo</span></div>}<input type="file" accept="image/*" className="hidden" onChange={handlePhotoChange} /></label></div><button onClick={() => onSave(review, photo)} className="w-full bg-pink-500 text-white py-3 rounded-2xl font-black shadow-cute hover:bg-pink-600 transition-colors">Save to Memory Lane</button></ModalWrapper>); };

        // --- 4. View Components ---
        function CastleView({ chores, completed, events, goals, bills, ious, user, settings, onOpenSettings, onToggleChore, onOpenMeeting }) {
            const duckyScore = completed.filter(c => c.completedBy === 'Ducky').length;
            const pipsScore = completed.filter(c => c.completedBy === 'Pips').length;
            const scoreDiff = duckyScore - pipsScore;
            const margin = 5; 
            let currentFlag = settings.kingdomFlag;
            let ruler = 'The Kingdom';
            let flagColor = 'text-pink-500';
            if (scoreDiff > margin) { currentFlag = settings.duckyFlag; ruler = "Ducky's Reign"; flagColor = 'text-yellow-600'; }
            else if (scoreDiff < -margin) { currentFlag = settings.pipsFlag; ruler = "Pips's Reign"; flagColor = 'text-blue-600'; }

            const today = new Date();
            const todaysChores = chores.filter(c => !c.dueDate || new Date(c.dueDate) <= today).slice(0, 3);
            const todaysEvents = events.filter(e => { if (!e.date) return false; const d = new Date(e.date); return d.getDate() === today.getDate() && d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear(); });

            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-[2.5rem] p-6 text-center relative overflow-hidden border-4 border-white shadow-lg">
                        <button onClick={onOpenSettings} className="absolute top-4 right-4 text-gray-300 hover:text-gray-500 bg-gray-50 p-2 rounded-full"><Settings size={18}/></button>
                        <div className="h-32 flex items-end justify-center mb-2 relative">
                            <div className="absolute top-0 flex flex-col items-center animate-float"><div className={`text-4xl filter drop-shadow-md ${flagColor}`}>{currentFlag}</div><div className="h-12 w-1 bg-gray-300"></div></div>
                            <svg viewBox="0 0 100 60" className="w-48 h-auto text-gray-200 fill-current"><path d="M10 60 V30 L5 30 L5 20 L15 10 L25 20 L25 30 L20 30 V60 H10 Z" /><path d="M80 60 V30 L75 30 L75 20 L85 10 L95 20 L95 30 L90 30 V60 H80 Z" /><path d="M20 60 V40 H80 V60 Z" /><path d="M40 60 V45 A10 10 0 0 1 60 45 V60 Z" fill="#4b5563" /></svg>
                        </div>
                        <h2 className="text-2xl font-black text-gray-800">{settings.name}</h2>
                        <p className={`text-xs font-bold uppercase tracking-widest mt-1 ${flagColor}`}>{ruler}</p>
                    </div>

                    <button onClick={onOpenMeeting} className="w-full bg-gradient-to-r from-gray-800 to-black p-5 rounded-2xl shadow-lg flex items-center justify-between group hover:scale-[1.02] transition-transform">
                        <div className="text-left">
                            <h3 className="text-white font-black text-lg flex items-center gap-2"><Users size={20} className="text-pink-400"/> Daily Family Meeting</h3>
                            <p className="text-gray-400 text-xs mt-1">Check-in, Plan, & Connect</p>
                        </div>
                        <div className="bg-white/10 p-3 rounded-full group-hover:bg-white/20 transition-colors">
                            <ArrowRight className="text-white" size={20}/>
                        </div>
                    </button>

                    <div>
                        <h3 className="text-gray-400 font-bold text-xs uppercase tracking-wider mb-3 ml-1 flex items-center gap-2"><CalendarDays size={14}/> Today's Scroll</h3>
                        <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-4">
                            {todaysEvents.length > 0 && <div><h4 className="text-[10px] font-bold text-pink-400 uppercase mb-2">Events</h4>{todaysEvents.map(e => <div key={e.id} className="flex items-center gap-2 text-sm text-gray-700 mb-1"><span className="text-xs bg-pink-50 text-pink-600 px-1.5 rounded">{e.time}</span><span>{e.title}</span></div>)}</div>}
                            <div><h4 className="text-[10px] font-bold text-blue-400 uppercase mb-2">Priority Tasks</h4>{todaysChores.length === 0 ? <p className="text-xs text-gray-400 italic">Nothing pressing!</p> : todaysChores.map(c => <div key={c.id} className="flex items-center gap-3 mb-2 p-2 bg-gray-50 rounded-xl cursor-pointer" onClick={() => onToggleChore(c)}><div className="w-5 h-5 border-2 border-gray-300 rounded-full flex items-center justify-center bg-white"><div className="w-3 h-3 bg-transparent rounded-full hover:bg-green-400"></div></div><span className="text-sm font-medium text-gray-700">{c.title}</span></div>)}</div>
                        </div>
                    </div>
                    <div>
                        <h3 className="text-gray-400 font-bold text-xs uppercase tracking-wider mb-3 ml-1 flex items-center gap-2"><TrendingUp size={14}/> Kingdom Stats</h3>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-yellow-50 rounded-2xl p-4 border border-yellow-100 text-center"><div className="text-2xl mb-1">üê•</div><div className="text-3xl font-black text-yellow-800">{duckyScore}</div><div className="text-[10px] font-bold text-yellow-600 uppercase">Ducky's Deeds</div></div>
                            <div className="bg-blue-50 rounded-2xl p-4 border border-blue-100 text-center"><div className="text-2xl mb-1">üê¶</div><div className="text-3xl font-black text-blue-800">{pipsScore}</div><div className="text-[10px] font-bold text-blue-600 uppercase">Pips's Deeds</div></div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Shared Components (Other Views) ---
        function MyListView({ chores, onToggle, onDelete, user, progress }) {
            const pretty = chores.filter(c => c.isPrettyPlease); const regular = chores.filter(c => !c.isPrettyPlease);
            const sort = (list) => list.sort((a, b) => { if (!a.dueDate) return 1; if (!b.dueDate) return -1; return new Date(a.dueDate) - new Date(b.dueDate); });
            return (
                <div className="space-y-6">
                    <ProgressBar current={progress} max={CHORES_PER_COUPON} label="Next Coupon" color={user === 'Ducky' ? 'bg-yellow-400' : 'bg-blue-400'} />
                    {pretty.length > 0 && <div className="bg-pink-50 rounded-2xl p-4 border-2 border-pink-200 shadow-sm"><h2 className="text-pink-600 font-bold flex items-center gap-2 mb-3 text-sm uppercase tracking-wider"><Sparkles size={16} /> Pretty Please</h2><div className="space-y-3">{pretty.map(chore => <ChoreItem key={chore.id} chore={chore} onToggle={onToggle} onDelete={onDelete} isPretty={true} />)}</div></div>}
                    <div><h2 className="text-gray-400 font-bold text-xs uppercase tracking-wider mb-3 ml-1">Current List</h2>{regular.length === 0 ? <div className="text-center py-12 opacity-50"><div className="text-4xl mb-2">üéâ</div><p className="text-sm font-medium">All done!</p></div> : <div className="space-y-3">{sort(regular).map(chore => <ChoreItem key={chore.id} chore={chore} onToggle={onToggle} onDelete={onDelete} />)}</div>}</div>
                </div>
            );
        }

        function ShoppingListView({ items, onAdd, onToggle, onDelete }) {
            const [newItem, setNewItem] = useState('');
            const handleAdd = (e) => { e.preventDefault(); if(!newItem)return; onAdd({text:newItem, completed:false}); setNewItem(''); };
            return (
                <div className="space-y-4">
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
                        <div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-gray-800 flex items-center gap-2"><ShoppingCart size={20} className="text-orange-400"/> Shopping List</h2></div>
                        <form onSubmit={handleAdd} className="flex gap-2 mb-4"><input value={newItem} onChange={e=>setNewItem(e.target.value)} className="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-orange-300" placeholder="Add item..." /><button type="submit" className="bg-orange-400 text-white p-2 rounded-xl shadow-sm hover:bg-orange-500"><Plus size={20}/></button></form>
                        <div className="space-y-2">{items.length===0&&<p className="text-center text-gray-300 text-xs py-4">Fridge is full!</p>}{items.map(item=><div key={item.id} className="flex items-center gap-3 p-2 rounded-xl hover:bg-gray-50 group"><div onClick={()=>onToggle(item.id, !item.completed)} className={`w-5 h-5 rounded border flex items-center justify-center cursor-pointer ${item.completed?'bg-orange-400 border-orange-400':'border-gray-300'}`}>{item.completed&&<CheckCircle size={12} className="text-white"/>}</div><span className={`flex-1 text-sm ${item.completed?'text-gray-300 line-through':'text-gray-700'}`}>{item.text}</span><button onClick={()=>onDelete(item.id)} className="text-gray-200 hover:text-red-400 opacity-0 group-hover:opacity-100"><Trash2 size={14}/></button></div>)}</div>
                    </div>
                </div>
            );
        }

        function AssignView({ chores, onVote }) {
            const [current, setCurrent] = useState(0); const [dir, setDir] = useState(null);
            const chore = chores[current];
            const swipe = (d) => { setDir(d); setTimeout(() => { if (chore) onVote(chore.id, d); setDir(null); setCurrent(0); }, 300); };
            if (chores.length === 0) return <div className="flex flex-col items-center justify-center h-full text-center text-gray-400"><div className="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-4"><CheckCircle size={40} className="text-gray-300" /></div><p>Caught up!</p></div>;
            return (
                <div className="flex flex-col items-center justify-center h-full relative">
                    <h2 className="absolute top-0 text-xs font-bold text-gray-400 uppercase tracking-widest mb-8">Swipe to Assign</h2>
                    <div className="relative w-full max-w-xs h-80 perspective-1000">
                        {chores.length > 1 && <div className="absolute top-4 left-4 w-full h-full bg-white border border-gray-100 rounded-3xl shadow-sm z-0 transform scale-95 opacity-50"></div>}
                        {chore && <div className={`absolute top-0 left-0 w-full h-full bg-white border border-gray-200 rounded-3xl shadow-xl z-10 flex flex-col items-center justify-center p-8 text-center transition-all duration-300 ease-out transform ${dir === 'left' ? '-translate-x-full rotate-[-20deg] opacity-0' : ''} ${dir === 'right' ? 'translate-x-full rotate-[20deg] opacity-0' : ''}`}>{chore.isPrettyPlease && <Sparkles className="text-pink-400 mb-4" size={32} />}<h3 className="text-2xl font-black text-gray-800 mb-2">{chore.title}</h3><div className="absolute bottom-8 w-full px-8 flex justify-between text-xs font-bold uppercase tracking-wider text-gray-300"><span className="text-blue-300">{'< Pips'}</span><span className="text-yellow-400">{'Ducky >'}</span></div></div>}
                    </div>
                    <div className="flex gap-8 mt-12"><button onClick={() => swipe('left')} className="w-16 h-16 bg-white border-2 border-blue-100 text-blue-400 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-all"><ArrowLeft size={24} /></button><button onClick={() => swipe('right')} className="w-16 h-16 bg-white border-2 border-yellow-100 text-yellow-500 rounded-full shadow-lg flex items-center justify-center hover:scale-110 transition-all"><ArrowRight size={24} /></button></div>
                </div>
            );
        }

        function BudgetView({ bills, income, ious, user, onUpdateIncome, onMarkPaid, onDeleteBill, onRequestIOU, onClearIOU }) {
            const tot = (Number(income.ducky)||0)+(Number(income.pips)||0); const dr = tot>0?(Number(income.ducky)/tot):0.5; const pr = tot>0?(Number(income.pips)/tot):0.5;
            const paid = bills.filter(b=>b.paid); const unpaid = bills.filter(b=>!b.paid);
            const dp = paid.filter(b=>b.paidBy==='Ducky').reduce((s,b)=>s+Number(b.amount),0); const pp = paid.filter(b=>b.paidBy==='Pips').reduce((s,b)=>s+Number(b.amount),0);
            return (
                <div className="space-y-6">
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100"><h2 className="text-xs font-bold text-gray-400 uppercase mb-3">Fair Share</h2><div className="flex gap-4 mb-4"><input type="number" className="w-full bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-sm" value={income.ducky} onChange={(e)=>onUpdateIncome({ducky:e.target.value})} placeholder="Ducky $"/><input type="number" className="w-full bg-blue-50 border border-blue-200 rounded-lg p-2 text-sm" value={income.pips} onChange={(e)=>onUpdateIncome({pips:e.target.value})} placeholder="Pips $"/></div><div className="h-4 bg-gray-100 rounded-full flex overflow-hidden"><div style={{width:`${dr*100}%`}} className="bg-yellow-300 h-full"></div><div style={{width:`${pr*100}%`}} className="bg-blue-300 h-full"></div></div></div>
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100"><h2 className="text-xs font-bold text-gray-400 uppercase mb-3">Paid</h2><div className="space-y-4"><div><div className="flex justify-between text-xs font-bold mb-1"><span className="text-yellow-600">Ducky</span><span>${dp}</span></div><div className="h-3 bg-gray-100 rounded-full overflow-hidden"><div style={{width:`${Math.min((dp/(dp+pp||1))*100,100)}%`}} className="bg-yellow-400 h-full"></div></div></div><div><div className="flex justify-between text-xs font-bold mb-1"><span className="text-blue-600">Pips</span><span>${pp}</span></div><div className="h-3 bg-gray-100 rounded-full overflow-hidden"><div style={{width:`${Math.min((pp/(dp+pp||1))*100,100)}%`}} className="bg-blue-400 h-full"></div></div></div></div></div>
                    <div className="bg-pink-50 rounded-2xl p-4 border-2 border-pink-200"><div className="flex justify-between items-center mb-3"><h2 className="text-pink-600 font-bold text-sm uppercase flex gap-2"><HandCoins size={16}/> IOU</h2><button onClick={onRequestIOU} className="bg-white text-pink-500 px-3 py-1 rounded-full text-xs font-bold shadow-sm">Request</button></div>{ious.map(i=><div key={i.id} className="bg-white p-3 rounded-xl border border-pink-100 flex justify-between items-center mb-2"><div><div className="text-xs font-bold text-gray-700">{i.from} owes {i.to} ${i.amount}</div><div className="text-[10px] text-gray-400">{i.reason}</div></div><button onClick={()=>onClearIOU(i.id)} className="text-gray-300 hover:text-green-500"><CheckCircle size={16}/></button></div>)}</div>
                    <div><h2 className="text-gray-400 font-bold text-xs uppercase mb-3 ml-1">Bills Due</h2>{unpaid.map(b=><div key={b.id} className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex justify-between items-center mb-2"><div><h3 className="font-bold text-gray-800">{b.title}</h3><div className="text-xs font-bold text-gray-500">${b.amount}</div></div><button onClick={()=>onMarkPaid(b)} className="w-8 h-8 rounded-full border-2 border-gray-200 flex items-center justify-center text-gray-300 hover:text-green-500"><CheckCircle size={18}/></button></div>)}</div>
                </div>
            );
        }

        function GoalsView({ goals, user, onUpdate, onDelete }) {
            const [filter, setFilter] = useState('mine');
            const items = goals.filter(g => filter==='ours'?g.type==='shared':(filter==='mine'?g.type==='personal'&&g.owner===user:g.type==='personal'&&g.owner!==user));
            return (
                <div className="space-y-6">
                    <div className="flex bg-gray-200 p-1 rounded-xl"><button onClick={()=>setFilter('mine')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${filter==='mine'?'bg-white shadow text-gray-800':'text-gray-500'}`}>Me</button><button onClick={()=>setFilter('ours')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${filter==='ours'?'bg-white shadow text-gray-800':'text-gray-500'}`}>Us</button><button onClick={()=>setFilter('partner')} className={`flex-1 py-2 rounded-lg text-xs font-bold ${filter==='partner'?'bg-white shadow text-gray-800':'text-gray-500'}`}>Them</button></div>
                    <div className="space-y-3">{items.map(g => <GoalItem key={g.id} goal={g} onUpdate={onUpdate} onDelete={onDelete} />)}</div>
                </div>
            );
        }

        function CalendarView({ events, user, onAck, onDelete }) {
            const [date, setDate] = useState(new Date()); const [sel, setSel] = useState(new Date());
            const daysInMonth = new Date(date.getFullYear(), date.getMonth()+1, 0).getDate();
            const startDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            const days = []; for(let i=0;i<startDay;i++) days.push(<div key={`e-${i}`}></div>);
            for(let i=1;i<=daysInMonth;i++) {
                const d = new Date(date.getFullYear(), date.getMonth(), i);
                const evs = events.filter(e=>{if(!e.date)return false; const ed=new Date(e.date); return ed.getDate()===i && ed.getMonth()===date.getMonth() && ed.getFullYear()===date.getFullYear();});
                const isSel = d.getDate()===sel.getDate() && d.getMonth()===sel.getMonth();
                days.push(<div key={i} onClick={()=>setSel(d)} className={`h-12 border-t border-gray-50 flex flex-col items-center justify-center cursor-pointer ${isSel?'bg-pink-50':''}`}><span className="text-sm font-bold text-gray-700">{i}</span><div className="flex gap-0.5 mt-1">{evs.slice(0,3).map(e=><div key={e.id} className={`w-1.5 h-1.5 rounded-full ${e.type==='shared'?'bg-pink-400':(e.owner==='Ducky'?'bg-yellow-400':'bg-blue-400')}`}></div>)}</div></div>);
            }
            const selEvs = events.filter(e=>{if(!e.date)return false; const ed=new Date(e.date); return ed.getDate()===sel.getDate() && ed.getMonth()===sel.getMonth() && ed.getFullYear()===sel.getFullYear();});
            return (
                <div className="space-y-4">
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100"><div className="flex justify-between items-center mb-4"><button onClick={()=>setDate(new Date(date.getFullYear(),date.getMonth()-1,1))}><ChevronLeft size={20}/></button><h2 className="text-lg font-black">{date.toLocaleString('default',{month:'long',year:'numeric'})}</h2><button onClick={()=>setDate(new Date(date.getFullYear(),date.getMonth()+1,1))}><ChevronRight size={20}/></button></div><div className="grid grid-cols-7 text-center mb-2">{['S','M','T','W','T','F','S'].map(d=><span key={d} className="text-[10px] font-bold text-gray-400">{d}</span>)}</div><div className="grid grid-cols-7 text-center">{days}</div></div>
                    <div><h3 className="text-gray-400 font-bold text-xs uppercase mb-3 ml-1">{sel.toLocaleDateString()}</h3><div className="space-y-3">{selEvs.map(e=><div key={e.id} className="bg-white rounded-xl p-4 shadow-sm border-l-4 border-pink-400 flex justify-between items-center"><div><div className="font-bold text-gray-800">{e.title}</div><div className="text-xs text-gray-500 flex items-center gap-1"><Clock size={12}/> {e.time}</div></div><div className="flex gap-2">{e.type==='shared'&&e.acks&&!e.acks[user]&&<button onClick={()=>onAck(e.id)} className="bg-orange-100 text-orange-600 px-3 py-1 rounded-full text-xs font-bold">Ack</button>}<button onClick={()=>onDelete(e.id)} className="text-gray-300"><Trash2 size={16}/></button></div></div>)}</div></div>
                </div>
            );
        }

        function RewardsView({ coupons, currentUser, onRedeem }) {
            const myCoupons = coupons.filter(c => c.owner === currentUser && !c.isUsed);
            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-purple-500 to-indigo-500 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                        <div className="relative z-10"><h2 className="text-2xl font-black mb-1">Your Wallet</h2><p className="opacity-80 text-sm">You have {myCoupons.length} coupons available.</p></div>
                        <Gift className="absolute -bottom-4 -right-4 text-white opacity-20" size={100} />
                    </div>
                    <div className="grid grid-cols-1 gap-4">
                        {myCoupons.length === 0 ? <div className="text-center py-10 text-gray-400 bg-white rounded-2xl border border-dashed border-gray-200"><p>No coupons yet!</p><p className="text-xs mt-1">Complete chores to earn them.</p></div> : 
                            myCoupons.map(coupon => (
                                <div key={coupon.id} className="bg-white rounded-xl border-2 border-dashed border-indigo-200 p-4 flex items-center justify-between">
                                    <div><h3 className="font-bold text-gray-800">{coupon.title}</h3><p className="text-[10px] text-gray-400 uppercase tracking-wider mt-1">Valid forever</p></div>
                                    <button onClick={() => onRedeem(coupon)} className="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-100">Use</button>
                                </div>
                            ))
                        }
                    </div>
                </div>
            );
        }

        function DateNightView({ history, progress, onLog, resetProgress }) {
            const [showGenerator, setShowGenerator] = useState(false);
            const [generatedDate, setGeneratedDate] = useState(null);
            const isUnlocked = progress >= CHORES_PER_DATENIGHT;

            const generate = () => {
                if (!isUnlocked) return;
                const date = { vibe: DATE_VIBES[Math.floor(Math.random() * DATE_VIBES.length)], activity: DATE_ACTIVITIES[Math.floor(Math.random() * DATE_ACTIVITIES.length)], food: DATE_FOODS[Math.floor(Math.random() * DATE_FOODS.length)], place: DATE_PLACES[Math.floor(Math.random() * DATE_PLACES.length)], date: new Date().toISOString() };
                setGeneratedDate(date);
                setShowGenerator(true);
            };

            const handleSaveDate = (review, photo) => { onLog({ ...generatedDate, review, photo }); resetProgress(CHORES_PER_DATENIGHT); setShowGenerator(false); setGeneratedDate(null); };

            return (
                <div className="space-y-8">
                    <div className="text-center bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h2 className="text-lg font-black text-gray-800 mb-4">Date Night Progress</h2>
                        <div className="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
                            <svg className="w-full h-full transform -rotate-90"><circle cx="80" cy="80" r="70" stroke="#f3f4f6" strokeWidth="12" fill="none" /><circle cx="80" cy="80" r="70" stroke="#ec4899" strokeWidth="12" fill="none" strokeDasharray="440" strokeDashoffset={440 - (440 * Math.min(progress / CHORES_PER_DATENIGHT, 1))} className="transition-all duration-1000" /></svg>
                            <div className="absolute inset-0 flex flex-col items-center justify-center"><span className="text-3xl font-black text-gray-800">{Math.min(progress, CHORES_PER_DATENIGHT)}</span><span className="text-xs text-gray-400 font-bold uppercase">of {CHORES_PER_DATENIGHT}</span></div>
                        </div>
                        <button onClick={generate} disabled={!isUnlocked} className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transform transition-all ${isUnlocked ? 'bg-gradient-to-r from-pink-500 to-red-500 text-white hover:scale-105 active:scale-95' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}>{isUnlocked ? "üé≤ Roll for Date Night!" : "Keep Working Together!"}</button>
                    </div>
                    {showGenerator && <DateGeneratorModal date={generatedDate} onClose={() => setShowGenerator(false)} onSave={handleSaveDate} />}
                    <div>
                        <h3 className="font-bold text-gray-400 text-xs uppercase tracking-wider mb-4">Memory Lane</h3>
                        <div className="space-y-4">
                            {history.map(item => (
                                <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                                    <div className="flex justify-between items-start mb-2"><div className="flex gap-2"><span className="bg-pink-100 text-pink-600 text-[10px] font-bold px-2 py-1 rounded-full">{item.vibe}</span><span className="bg-blue-100 text-blue-600 text-[10px] font-bold px-2 py-1 rounded-full">{item.food}</span></div><span className="text-[10px] text-gray-400">{new Date(item.date).toLocaleDateString()}</span></div>
                                    <h4 className="font-bold text-gray-800 text-lg mb-1">{item.activity} @ {item.place}</h4>
                                    {item.review && <p className="text-sm text-gray-600 italic">"{item.review}"</p>}
                                    {item.photo && <img src={item.photo} alt="Memory" className="mt-3 rounded-lg w-full h-32 object-cover" />}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Main App ---
        function ChoreApp() {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [tab, setTab] = useState('castle');
            
            // Data
            const [chores, setChores] = useState([]);
            const [coupons, setCoupons] = useState([]);
            const [dates, setDates] = useState([]);
            const [bills, setBills] = useState([]);
            const [ious, setIous] = useState([]);
            const [goals, setGoals] = useState([]);
            const [events, setEvents] = useState([]);
            const [shop, setShop] = useState([]);
            const [income, setIncome] = useState({ ducky: 0, pips: 0 });
            const [castle, setCastle] = useState({ name: 'Our Kingdom', kingdomFlag: 'üè∞', duckyFlag: 'üê•', pipsFlag: 'üê¶' });
            const [profiles, setProfiles] = useState({
                Ducky: { name: 'Ducky', icon: 'üê•', theme: 'Yellow' },
                Pips: { name: 'Pips', icon: 'üê¶', theme: 'Blue' }
            });

            // UI
            const [modals, setModals] = useState({ chore: false, bill: false, goal: false, event: false, iou: false, castle: false, meeting: false, shop: false, profile: false });
            const [conflict, setConflict] = useState(null);
            const [redeem, setRedeem] = useState(null);

            // Init
            useEffect(() => {
                if (isOffline) {
                    return MockService.initAuth(setUser);
                }
                
                if (auth) {
                    const init = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch(e) {
                            console.error("Auth Failed", e);
                            try { await signInAnonymously(auth); } catch(e2) { console.error(e2); }
                        }
                    };
                    init();
                    return onAuthStateChanged(auth, (u) => { 
                        setUser(u); 
                        setProfile(localStorage.getItem('ducky_pips_profile')); 
                    });
                }
            }, []);

            // Sync
            useEffect(() => {
                if (!user) return;
                const subs = [];
                const subCol = (n, s) => { if (isOffline) subs.push(MockService.subscribe(n, (r) => { const d = r.docs.map(x=>({id:x.id,...x.data()})); if(s) d.sort(s); eval(`set${n.charAt(0).toUpperCase()+n.slice(1)}`)(d); })); else subs.push(onSnapshot(s ? query(collection(db, 'artifacts', appId, 'public', 'data', n), orderBy(s.f, s.o)) : collection(db, 'artifacts', appId, 'public', 'data', n), (r) => eval(`set${n.charAt(0).toUpperCase()+n.slice(1)}`)(r.docs.map(d=>({id:d.id,...d.data()}))))); };
                const subDoc = (n, i, cb) => { if (isOffline) subs.push(MockService.subscribeDoc(n, i, cb)); else subs.push(onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', n, i), cb)); };
                
                subCol('chores', {f:'createdAt',o:'asc'}); subCol('coupons'); subCol('bills'); subCol('ious', {f:'createdAt',o:'desc'}); subCol('goals'); subCol('events');
                if(isOffline) subs.push(MockService.subscribe('shopping', (r) => setShop(r.docs.map(x=>({id:x.id,...x.data()}))))); else subs.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'shopping'), (r) => setShop(r.docs.map(d=>({id:d.id,...d.data()})))));
                subDoc('settings', 'income', (s) => setIncome(s.exists() ? s.data() : {ducky:0,pips:0}));
                subDoc('settings', 'castle', (s) => { if(s.exists()) setCastle(s.data()); });
                subDoc('settings', 'profiles', (s) => { if(s.exists()) setProfiles(s.data()); });
                if(isOffline) subs.push(MockService.subscribe('datenights', (r) => setDates(r.docs.map(x=>({id:x.id,...x.data()})).sort((a,b) => (a.createdAt?.seconds||0)-(b.createdAt?.seconds||0))))); else subs.push(onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'datenights'), (r) => setDates(r.docs.map(d=>({id:d.id,...d.data()})).sort((a,b) => (a.createdAt?.seconds||0)-(b.createdAt?.seconds||0)))));
                return () => subs.forEach(u => u && u());
            }, [user]);

            // Derived
            const myChores = useMemo(() => chores.filter(c => c.assignedTo === profile && c.status !== 'completed'), [chores, profile]);
            const unassigned = useMemo(() => chores.filter(c => !c.assignedTo && !(c.votes && c.votes[profile])), [chores, profile]);
            const completed = useMemo(() => chores.filter(c => c.status === 'completed'), [chores]);
            const myCount = completed.filter(c => c.completedBy === profile && !c.redeemedForCoupon).length;
            const totalCount = completed.filter(c => !c.redeemedForDate).length;
            const myTheme = profile ? THEME_COLORS.find(c => c.name === profiles[profile]?.theme) || THEME_COLORS[0] : THEME_COLORS[0];

            const act = async (type, col, id, data) => {
                const pl = { ...data, createdAt: isOffline ? { seconds: Date.now()/1000 } : serverTimestamp() };
                try {
                    if (type === 'add') { if (isOffline) await MockService.add(col, pl); else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', col), pl); }
                    else if (type === 'update') { if (isOffline) await MockService.update(col, id, data); else await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id), data); }
                    else if (type === 'delete') { if(!confirm("Are you sure?")) return; if (isOffline) await MockService.delete(col, id); else await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id)); }
                    else if (type === 'set') { if (isOffline) await MockService.set(col, id, data); else await setDoc(doc(db, 'artifacts', appId, 'public', 'data', col, id), data); }
                } catch(e) { console.error(e); }
            };

            const toggleModal = (m, v) => setModals({...modals, [m]: v});

            useEffect(() => { if (!profile || !chores.length) return; const un = completed.filter(c => c.completedBy === profile && !c.redeemedForCoupon); if (un.length >= CHORES_PER_COUPON) { const ids = un.slice(0, CHORES_PER_COUPON).map(c => c.id); act('add', 'coupons', null, { title: COUPON_TYPES[Math.floor(Math.random()*COUPON_TYPES.length)], owner: profile, isUsed: false }); ids.forEach(id => act('update', 'chores', id, { redeemedForCoupon: true })); } }, [completed, profile]);

            if (!user) return <div className="p-10 text-center flex flex-col items-center justify-center min-h-screen text-gray-400 animate-pulse"><Heart size={48} className="text-pink-300 mb-4" /><p>Loading...</p></div>;
            if (!profile) return (
                <div className="min-h-screen bg-pink-50 flex flex-col items-center justify-center p-6 text-center font-sans fade-in">
                    <h1 className="text-5xl font-black text-pink-500 mb-10 drop-shadow-sm tracking-tight animate-bounce-slight">Who are you?</h1>
                    <div className="flex gap-8">
                        <button onClick={() => {setProfile('Ducky'); localStorage.setItem('ducky_pips_profile', 'Ducky');}} className="w-44 h-44 bg-themeYellow rounded-[3rem] shadow-cute border-4 border-white flex flex-col items-center justify-center hover:scale-105 transition-transform"><div className="text-7xl mb-2">{profiles.Ducky.icon}</div><span className="text-2xl font-black text-themeYellowDark">{profiles.Ducky.name}</span></button>
                        <button onClick={() => {setProfile('Pips'); localStorage.setItem('ducky_pips_profile', 'Pips');}} className="w-44 h-44 bg-themeBlue rounded-[3rem] shadow-cute border-4 border-white flex flex-col items-center justify-center hover:scale-105 transition-transform"><div className="text-7xl mb-2">{profiles.Pips.icon}</div><span className="text-2xl font-black text-themeBlueDark">{profiles.Pips.name}</span></button>
                    </div>
                    {isOffline && <div className="mt-8 bg-orange-100 text-orange-600 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2"><WifiOff size={14}/> Offline Mode</div>}
                </div>
            );

            const openAddModal = () => {
                if (tab === 'budget') toggleModal('bill', true);
                else if (tab === 'goals') toggleModal('goal', true);
                else if (tab === 'calendar') toggleModal('event', true);
                else if (tab === 'shop') toggleModal('shop', true);
                else toggleModal('chore', true);
            };

            const renderContent = () => {
                switch(tab) {
                    case 'castle': return <CastleView chores={myChores} completed={completed} events={events} goals={goals} bills={bills} ious={ious} user={profile} settings={castle} onOpenSettings={() => toggleModal('castle', true)} onToggleChore={(c) => act('update', 'chores', c.id, {status: 'completed', completedAt: isOffline?{seconds:Date.now()/1000}:serverTimestamp(), completedBy: profile})} onOpenMeeting={() => toggleModal('meeting', true)} />;
                    case 'list': return <MyListView chores={myChores} onToggle={(c) => act('update', 'chores', c.id, {status: 'completed', completedAt: isOffline?{seconds:Date.now()/1000}:serverTimestamp(), completedBy: profile})} onDelete={(id) => act('delete', 'chores', id)} user={profile} progress={myCount} />;
                    case 'assign': return <AssignView chores={unassigned} onVote={(id, dir) => { const a=dir==='left'?'Pips':'Ducky'; const c=chores.find(x=>x.id===id); const o=profile==='Ducky'?'Pips':'Ducky'; if(c.votes&&c.votes[o]){ if(c.votes[o]===a) act('update','chores',id,{assignedTo:a,votes:{}}); else { setConflict({title:c.title}); act('update','chores',id,{votes:{},createdAt:isOffline?{seconds:Date.now()/1000+100}:serverTimestamp()}); } } else act('update','chores',id,{[`votes.${profile}`]:a}); }} />;
                    case 'dates': return <DateNightView history={dates} progress={totalCount} onLog={(d) => act('add', 'datenights', null, d)} resetProgress={(c) => completed.filter(x=>!x.redeemedForDate).sort((a,b)=>(a.completedAt?.seconds||0)-(b.createdAt?.seconds||0)).slice(0,c).forEach(x => act('update', 'chores', x.id, { redeemedForDate: true }))} />;
                    case 'calendar': return <CalendarView events={events} user={profile} onAck={(id) => { const e = events.find(x=>x.id===id); if(e) act('update', 'events', id, { acks: {...e.acks, [profile]: true} }); }} onDelete={(id) => act('delete', 'events', id)} />;
                    case 'budget': return <BudgetView bills={bills} income={income} ious={ious} user={profile} onUpdateIncome={(d) => act('set', 'settings', 'income', {...income, ...d})} onMarkPaid={(b) => act('update', 'bills', b.id, { paid: !b.paid, paidBy: !b.paid ? profile : null })} onDeleteBill={(id) => act('delete', 'bills', id)} onRequestIOU={() => toggleModal('iou', true)} onClearIOU={(id) => act('delete', 'ious', id)} />;
                    case 'shop': return <ShoppingListView items={shop} onAdd={(d) => act('add', 'shopping', null, d)} onToggle={(id, c) => act('update', 'shopping', id, { completed: c })} onDelete={(id) => act('delete', 'shopping', id)} />;
                    case 'goals': return <GoalsView goals={goals} user={profile} onUpdate={(id, d) => act('update', 'goals', id, d)} onDelete={(id) => act('delete', 'goals', id)} />;
                    case 'rewards': return <RewardsView coupons={coupons} currentUser={profile} onRedeem={(c) => setRedeem(c)} />;
                    default: return null;
                }
            };

            return (
                <div className={`min-h-screen flex flex-col font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative fade-in ${myTheme.bg} transition-colors duration-500`}>
                    <header className="bg-white/80 backdrop-blur-md p-5 pt-7 shadow-sm z-10 flex justify-between items-center select-none rounded-b-[2.5rem]">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center text-2xl shadow-sm border-2 border-gray-100">{profiles[profile]?.icon}</div>
                            <div>
                                <h1 className="text-2xl font-black text-gray-800 tracking-tight flex items-center gap-2">
                                    {tab === 'castle' && "Our Kingdom"} {tab === 'list' && "My Chores"} {tab === 'assign' && "Assign Tasks"} 
                                    {tab === 'dates' && "Date Night"} {tab === 'calendar' && "Calendar"} 
                                    {tab === 'budget' && "Treasury"} {tab === 'shop' && "Market"} 
                                    {tab === 'goals' && "Life Goals"} {tab === 'rewards' && "Prizes"}
                                </h1>
                                <button onClick={()=>toggleModal('profile', true)} className="text-xs text-gray-400 font-bold hover:text-gray-600 flex items-center gap-1"><Edit3 size={10}/> Customize</button>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => {setProfile(null); localStorage.removeItem('ducky_pips_profile');}} className="p-2 bg-gray-50 rounded-full text-gray-300 hover:text-red-400 transition-colors"><LogOut size={20} /></button>
                            {tab !== 'rewards' && tab !== 'dates' && tab !== 'castle' && <button onClick={openAddModal} className="w-12 h-12 bg-black text-white rounded-2xl flex items-center justify-center shadow-cute hover:scale-110 transition-transform active:scale-90"><Plus size={28} strokeWidth={3}/></button>}
                        </div>
                    </header>
                    
                    <main className="flex-1 overflow-y-auto p-4 pb-40 relative no-scrollbar">
                        {renderContent()}
                    </main>

                    <div className="fixed bottom-0 w-full max-w-md px-4 pb-6 pt-12 z-40 flex justify-between items-end pointer-events-none">
                        <div className="bg-white/95 backdrop-blur-md rounded-[2.5rem] p-1.5 grid grid-cols-2 gap-1 shadow-xl border-4 border-white pointer-events-auto w-[42%]">
                            <NavButton active={tab === 'dates'} onClick={() => setTab('dates')} icon={<Heart />} label="Dates" />
                            <NavButton active={tab === 'calendar'} onClick={() => setTab('calendar')} icon={<CalendarDays />} label="Plan" />
                            <NavButton active={tab === 'list'} onClick={() => setTab('list')} icon={<CheckCircle />} label="Chores" />
                            <NavButton active={tab === 'assign'} onClick={() => setTab('assign')} icon={<Repeat />} label="Assign" count={unassigned.length} />
                        </div>

                        <div className="pointer-events-auto -mb-6 mx-2 z-50">
                            <NavButton active={tab === 'castle'} onClick={() => setTab('castle')} icon={<Crown />} label="Kingdom" prominent={true} />
                        </div>

                        <div className="bg-white/95 backdrop-blur-md rounded-[2.5rem] p-1.5 grid grid-cols-2 gap-1 shadow-xl border-4 border-white pointer-events-auto w-[42%]">
                            <NavButton active={tab === 'budget'} onClick={() => setTab('budget')} icon={<PiggyBank />} label="Budget" />
                            <NavButton active={tab === 'shop'} onClick={() => setTab('shop')} icon={<ShoppingCart />} label="Shop" />
                            <NavButton active={tab === 'goals'} onClick={() => setTab('goals')} icon={<Target />} label="Goals" />
                            <NavButton active={tab === 'rewards'} onClick={() => setTab('rewards')} icon={<Gift />} label="Rewards" />
                        </div>
                    </div>

                    {modals.chore && <AddChoreModal onClose={() => toggleModal('chore', false)} onAdd={(d) => { let assigned = null; if (d.isPrettyPlease) assigned = profile === 'Ducky' ? 'Pips' : 'Ducky'; act('add', 'chores', null, { ...d, status: 'pending', assignedTo: assigned, createdBy: profile, votes: {} }); toggleModal('chore', false); }} />}
                    {modals.bill && <AddBillModal onClose={() => toggleModal('bill', false)} onAdd={(d) => { act('add', 'bills', null, { ...d, paid: false, paidBy: null }); toggleModal('bill', false); }} />}
                    {modals.goal && <AddGoalModal onClose={() => toggleModal('goal', false)} onAdd={(d) => { act('add', 'goals', null, { ...d, savedAmount: 0, tasks: [] }); toggleModal('goal', false); }} user={profile} />}
                    {modals.event && <AddEventModal onClose={() => toggleModal('event', false)} onAdd={(d) => { const pl = { ...d, acks: {[profile]: true} }; if(d.type==='shared') pl.acks[profile==='Ducky'?'Pips':'Ducky'] = false; act('add', 'events', null, pl); toggleModal('event', false); }} user={profile} />}
                    {modals.iou && <IOUModal onClose={() => toggleModal('iou', false)} onRequest={(amt, res) => { act('add', 'ious', null, { from: profile, to: profile==='Ducky'?'Pips':'Ducky', amount: parseFloat(amt), reason: res, type: 'borrow' }); toggleModal('iou', false); }} from={profile} />}
                    {modals.meeting && <MeetingModal onClose={() => toggleModal('meeting', false)} chores={chores} events={events} user={profile} onAdd={(d) => act('add', 'chores', null, { ...d, status: 'pending', createdBy: profile, votes: {} })} />}
                    {modals.shop && <AddShoppingModal onClose={() => toggleModal('shop', false)} onAdd={(d) => { act('add', 'shopping', null, d); toggleModal('shop', false); }} />}
                    {modals.profile && <ProfileSettingsModal onClose={() => toggleModal('profile', false)} profile={profile} settings={profiles[profile]} onSave={(s) => act('set', 'settings', 'profiles', { ...profiles, [profile]: s })} />}
                    
                    {modals.castle && (
                        <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-in fade-in">
                            <div className="bg-white rounded-[2rem] w-full max-w-sm p-6 shadow-2xl border-4 border-gray-100">
                                <h2 className="text-xl font-black text-gray-800 mb-4 flex items-center gap-2"><Settings className="text-gray-400"/> Kingdom Settings</h2>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Castle Name</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 font-bold" value={castle.name} onChange={e => setCastle({...castle, name: e.target.value})} /></div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Kingdom</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-center text-2xl" value={castle.kingdomFlag} onChange={e => setCastle({...castle, kingdomFlag: e.target.value})} /></div>
                                        <div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Ducky</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-center text-2xl" value={castle.duckyFlag} onChange={e => setCastle({...castle, duckyFlag: e.target.value})} /></div>
                                        <div><label className="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Pips</label><input className="w-full bg-gray-50 border-2 border-gray-200 rounded-xl p-3 text-center text-2xl" value={castle.pipsFlag} onChange={e => setCastle({...castle, pipsFlag: e.target.value})} /></div>
                                    </div>
                                    <button onClick={() => { act('set', 'settings', 'castle', castle); toggleModal('castle', false); }} className="w-full bg-black text-white py-3 rounded-xl font-bold mt-4 shadow-cute">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {conflict && <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 animate-in fade-in"><div className="bg-white rounded-[2rem] p-6 max-w-sm w-full text-center relative overflow-hidden shadow-2xl border-4 border-white"><div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><MessageCircle size={32} className="text-red-500" /></div><h3 className="text-xl font-black text-gray-800 mb-2">Wait, discuss this!</h3><p className="text-gray-500 mb-4 text-sm font-medium">Differing votes for <span className="font-bold text-gray-800">"{conflict.title}"</span>.</p><button onClick={() => setConflict(null)} className="w-full bg-black text-white py-3 rounded-xl font-bold shadow-cute">Okay</button></div></div>}
                    {redeem && <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-6 animate-in fade-in"><div className="bg-white rounded-[2rem] p-6 max-w-sm w-full text-center relative overflow-hidden shadow-2xl border-4 border-white"><div className="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4"><Gift size={32} className="text-indigo-600" /></div><h3 className="text-xl font-black text-gray-800 mb-2">Redeem?</h3><p className="text-gray-500 mb-6 text-sm font-medium">Use <span className="font-bold text-gray-800">"{redeem.title}"</span>?</p><div className="flex gap-3"><button onClick={() => setRedeem(null)} className="flex-1 py-3 font-bold text-gray-500 hover:bg-gray-100 rounded-xl">Cancel</button><button onClick={() => { act('update', 'coupons', redeem.id, { isUsed: true }); setRedeem(null); }} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-cute">Use It!</button></div></div></div>}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><ChoreApp /></ErrorBoundary>);
    </script>
</body>
</html>